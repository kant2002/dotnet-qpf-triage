<html>
<head>
<title>Dotnet Installer Viewer</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
<script type="module">
import { Octokit } from "https://cdn.skypack.dev/@octokit/rest";
import * as ko from "https://cdn.skypack.dev/knockout";

async function getLabels(octokit, owner, repo,) {
  const labels = await octokit.paginate('GET /repos/{owner}/{repo}/labels', {
    owner,
    repo,
  });
  return labels;
}

const octokit = new Octokit({});

const workCategory = [
  'Bug',
  'Epic',
  'Feature Request',
  'Theme',
  'User Story',
  'Work Item'
]

class Model
{
  constructor() {
    this.owner = 'dotnet';
    this.repo = 'wpf';
    this.loading = ko.observable(false);
    this.currentTab = ko.observable("Unknown labels");
    this.labels = ko.observableArray();
    this.costs = ko.observableArray();
    this.statuses = ko.observableArray();
    this.priorities = ko.observableArray();
    this.areas = ko.observableArray();
    this.tenets = ko.observableArray();
    this.ranks = ko.observableArray();
    this.servicing = ko.observableArray();
    this.portTargets = ko.observableArray();
    this.workCategories = ko.observableArray();
  }

  setTab(tab) {
    this.currentTab(tab);
  }

  async calculate() {
    if (this.loading()) {
      return;
    }

    this.loading(true);
    try {
      let labels = await getLabels(octokit, this.owner, this.repo);
      labels = labels.map(_ => {
        return { ..._, isBright: isBright(_.color) }
      })
      labels = labels.filter(_ => {
        if (_.name.startsWith("Cost:")) {
          this.costs.push(_);
          return false;
        }
        if (_.name.startsWith("Priority:")) {
          this.priorities.push(_);
          return false;
        }
        if (_.name.startsWith("Status:")) {
          this.statuses.push(_);
          return false;
        }
        if (_.name.startsWith("area-")) {
          this.areas.push(_);
          return false;
        }
        if (_.name.startsWith("tenet-")) {
          this.tenets.push(_);
          return false;
        }
        if (_.name.startsWith("rank")) {
          this.ranks.push(_);
          return false;
        }
        if (_.name.startsWith("Servicing-")) {
          this.servicing.push(_);
          return false;
        }
        if (_.name.startsWith("Port to")) {
          this.portTargets.push(_);
          return false;
        }
        if (workCategory.indexOf(_.name) !== -1) {
          this.workCategories.push(_);
          return false;
        }
        return true;
      });
      this.labels(labels);
    } finally {
      this.loading(false);
    }
  }
}

ko.components.register('labels-table', {
    viewModel: function(params) {
        this.labels = params.labels;
    },
    template:
        '<table>\
    <tbody data-bind="foreach: labels">\
        <tr>\
            <td>\
              <span class="badge rounded-pill" data-bind="text: name, attr: { title: description }, style: { backgroundColor: color }, css: { \'text-dark\': isBright}"></span>\
            </td>\
        </tr>\
    </tbody>\
  </table>'
});


function isBright(color) {
  const r = color.substr(0, 2);
  const g = color.substr(2, 2);
  const b = color.substr(4, 2);
  const s = Number.parseInt(r, 16) + Number.parseInt(g, 16) + Number.parseInt(b, 16);
  return s / 3 > 128;
}

const model = new Model();
ko.applyBindings(model);
model.calculate();
</script>
</head>
<body class="container">
  <h1>.NET WPF triage</h1>
  <form class="row g-3">
    <div class="col-md-6">
      <label for="inputRepoOwner" class="form-label">Repo owner:</label>
      <input id="inputRepoOwner" disabled type="text" class="form-control" data-bind="value: owner">
    </div>
    <div class="col-md-6">
      <label for="inputRepoName" class="form-label">Repo name:</label>
      <input id="inputRepoName" disabled type="text" class="form-control" data-bind="value: repo">
    </div>

    <div class="col-12">
      <input type="submit" class="btn btn-primary" data-bind="click: calculate" value="Read data" />
    </div>
  
  </form>
  <!-- ko if: loading -->
  <div class="spinner-border" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
  <!-- /ko -->
  <!-- ko ifnot: loading -->
  <ul class="nav nav-tabs">
    <li class="nav-item">
      <a class="nav-link active" data-bind="click: function () { setTab('Unknown labels') }, css: { active: currentTab() == 'Unknown labels'}">Unknown labels</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bind="click: function () { setTab('Allowed') }, css: { active: currentTab() == 'Allowed'}">Allowed</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bind="click: function () { setTab('Prohibited') }, css: { active: currentTab() == 'Prohibited'}">Prohibited</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bind="click: function () { setTab('Obsoleted') }, css: { active: currentTab() == 'Obsoleted'}">Obsoleted</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bind="click: function () { setTab('On case basis') }, css: { active: currentTab() == 'On case basis'}">On case basis</a>
    </li>
  </ul>
  <!-- ko if: currentTab() == 'Unknown labels' -->
  <h1>Uncategorized <span class="badge bg-secondary" data-bind="text: labels().length">Qty</span></h1>
  <labels-table params="labels: labels"></labels-table>
  <!-- /ko -->
  <!-- ko if: currentTab() == 'Prohibited' -->
  <h2>Costs</h2>
  <labels-table params="labels: costs"></labels-table>
  <h2>Priorities</h2>
  <labels-table params="labels: priorities"></labels-table>
  <h2>Statuses</h2>
  <labels-table params="labels: statuses"></labels-table>
  <h2>Servicing</h2>
  <labels-table params="labels: servicing"></labels-table>
  <h2>Port Targets</h2>
  <labels-table params="labels: portTargets"></labels-table>
  <!-- /ko -->
  <!-- ko if: currentTab() == 'Allowed' -->
  <h2>Areas</h2>
  <labels-table params="labels: areas"></labels-table>
  <!-- /ko -->
  <!-- ko if: currentTab() == 'Obsoleted' -->
  <h2>Tenets</h2>
  <labels-table params="labels: tenets"></labels-table>
  <h2>Ranks</h2>
  <labels-table params="labels: ranks"></labels-table>
  <h2>Work Category</h2>
  <p>This is Azure DevOps work categories</p>
  <labels-table params="labels: workCategories"></labels-table>
  <!-- /ko -->
  <!-- /ko -->
</body>
</html>
